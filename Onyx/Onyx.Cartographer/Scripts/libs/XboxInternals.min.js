var XboxInternals;!function(e){!function(e){!function(e){e[e.BigEndian=0]="BigEndian",e[e.LittleEndian=1]="LittleEndian",e[e.Default=0]="Default"}(e.EndianType||(e.EndianType={}));var t=e.EndianType,r=function(){function e(e){this.buffer=e,this.SetPosition(0),this.byteOrder=t.BigEndian}return e.prototype.SetEndian=function(e){this.byteOrder=e},e.prototype.GetEndian=function(){return this.byteOrder},e.prototype.SwapEndian=function(){this.byteOrder=this.byteOrder==t.BigEndian?t.LittleEndian:t.BigEndian},e.prototype.SetPosition=function(e){this._position=e},e.prototype.GetPosition=function(){return this._position},e.prototype.GetLength=function(){return this.buffer.byteLength},e.prototype.SetBuffer=function(e){this.buffer=e},e.prototype.ReadByte=function(){return this.Clone(new Uint8Array(this.buffer,this._position++,1))},e.prototype.ReadBytes=function(e){var t=new Uint8Array(this.buffer,this._position,e);return this.SetPosition(this.GetPosition()+e),this.Clone(t)},e.prototype.ReadUInt8=function(){var e=new DataView(this.buffer,this._position,1);return this.SetPosition(this.GetPosition()+1),e.getUint8(0)},e.prototype.ReadInt16=function(){var e=new DataView(this.buffer,this._position,2);return this.SetPosition(this.GetPosition()+2),e.getInt16(0,1==this.byteOrder)},e.prototype.ReadWord=function(){var e=new DataView(this.buffer,this._position,2);return this.SetPosition(this.GetPosition()+2),e.getUint16(0,1==this.byteOrder)},e.prototype.ReadInt24=function(e){"undefined"==typeof e&&(e=t.Default);var r=this.byteOrder;e!=t.Default&&(this.byteOrder=e);var n,i=this.ReadBytes(3);return n=this.byteOrder==t.LittleEndian?i[2]<<16|i[1]<<8|i[0]:i[0]<<16|i[1]<<8|i[2],this.byteOrder=r,n},e.prototype.ReadInt32=function(){var e=new DataView(this.buffer,this.GetPosition(),4);return this.SetPosition(this.GetPosition()+4),e.getInt32(0,1==this.byteOrder)},e.prototype.ReadDword=function(){var e=new DataView(this.buffer,this.GetPosition(),4);return this.SetPosition(this.GetPosition()+4),e.getUint32(0,1==this.byteOrder)},e.prototype.ReadMultiByte=function(e){switch(e){case 1:return this.ReadUInt8();case 2:return this.ReadWord();case 4:return this.ReadDword();default:throw"BaseIO: Invalid multi-byte size."}},e.prototype.ReadFloat=function(){var e=new DataView(this.buffer,this.GetPosition(),4);return this.SetPosition(this.GetPosition()+4),e.getFloat32(0,1==this.byteOrder)},e.prototype.ReadDouble=function(){var e=new DataView(this.buffer,this.GetPosition(),8);return this.SetPosition(this.GetPosition()+4),e.getFloat64(0,1==this.byteOrder)},e.prototype.ReadString=function(e,t,r,n){"undefined"==typeof e&&(e=-1),"undefined"==typeof t&&(t=0),"undefined"==typeof r&&(r=!0),"undefined"==typeof n&&(n=2147483647);var i=new Uint8Array(new Uint8Array(this.buffer,this._position,e)),o=0;for(o=0;o<i.length;o++)if(o+1<i.length&&i[o+1]==t){o++;break}var l=String.fromCharCode.apply(null,new Uint8Array(new Uint8Array(this.buffer,this._position,o)));return this.SetPosition(this.GetPosition()+e),l},e.prototype.ReadWString=function(e,t,r,n){"undefined"==typeof e&&(e=-1),"undefined"==typeof t&&(t=0),"undefined"==typeof r&&(r=!0),"undefined"==typeof n&&(n=2147483647);for(var i,o=new Uint16Array(e),l=0,s=this.GetPosition();(l++<e||-1==e)&&(i=this.ReadWord())!=t;)o[l-1]=i;return-1!=e&&this.SetPosition(s+e),String.fromCharCode.apply(null,o.subarray(0,l))},e.prototype.ReadImage=function(e){for(var t="",r=this.Clone(new Uint8Array(this.buffer,this._position,e)),n=0;n<r.length;n++)t+=String.fromCharCode(r[n]);var i=document.createElement("img");return i.src="data:image/png;base64,"+btoa(t),this.SetPosition(this.GetPosition()+e),i},e.prototype.WriteByte=function(e){var t=new DataView(this.buffer,this._position,1);t.setUint8(0,e[0]),this.SetPosition(this.GetPosition()+1)},e.prototype.WriteBytes=function(e){for(var t=new DataView(this.buffer,this._position,e.length),r=0;r<e.length;r++)t.setUint8(r,e[r]);this.SetPosition(this.GetPosition()+e.length)},e.prototype.WriteWord=function(e){var t=new DataView(this.buffer,this._position,2);t.setInt16(0,e,1==this.byteOrder),this.SetPosition(this.GetPosition()+2)},e.prototype.WriteDword=function(e){var t=new DataView(this.buffer,this._position,4);t.setInt32(0,e,1==this.byteOrder),this.SetPosition(this.GetPosition()+4)},e.prototype.WriteInt24=function(e,r){"undefined"==typeof r&&(r=t.Default);var n=new Uint8Array(3),i=this.byteOrder;if(r!=t.Default&&(this.byteOrder=r),this.byteOrder==t.LittleEndian){e<<=8;for(var o=0;3>o;o++)n[2-o]=255&e>>8*(o+1);this.reverseByteArray(n)}else for(var o=0;3>o;o++)n[2-o]=255&e>>8*o;this.WriteBytes(n),this.byteOrder=i},e.prototype.WriteString=function(e,t,r,n){"undefined"==typeof t&&(t=-1),"undefined"==typeof r&&(r=!0),"undefined"==typeof n&&(n=0);for(var i=new Uint8Array(e.length+(r?1:0)),o=0;o<e.length;o++)i[o]=e.charCodeAt(o);if(r&&(i[e.length]=n),this.WriteBytes(i),t>0){t-=e.length;for(var l=new Uint8Array(t),o=0;t>o;o++)l[o]=n;this.WriteBytes(l)}},e.prototype.reverseByteArray=function(e){for(var t,r=0;r<e.length/2;r++)t=e[r],e[r]=e[e.length-r-1],e[e.length-r-1]=t;return e},e.prototype.Clone=function(e){if(null==e||"object"!=typeof e)return e;if(e instanceof Date){var t=new Date;return t.setTime(e.getTime()),t}if(e instanceof Array){for(var t=[],r=0,n=e.length;n>r;r++)t[r]=this.Clone(e[r]);return t}if(e instanceof Object){var t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=this.Clone(e[i]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")},e.prototype.Save=function(e){var t=new Blob([this.buffer],{type:"application/octet-stream"});if(navigator.msSaveBlob)navigator.msSaveBlob(t,e);else{var r=document.createElement("a");r.download=e,null!=window.webkitURL?r.href=window.webkitURL.createObjectURL(t):(r.href=window.URL.createObjectURL(t),r.onclick=function(e){document.body.removeChild(e.target)},r.style.display="none",document.body.appendChild(r)),r.click()}},e}();e.BaseIO=r}(e.IO||(e.IO={})),e.IO}(XboxInternals||(XboxInternals={}));var __extends=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r},XboxInternals;!function(e){!function(e){var t=function(e){function t(t){e.call(this,t)}return __extends(t,e),t.LoadFromFile=function(e,r){var n=new FileReader;n.onloadend=function(){var i=new t(n.result);i.fileName=e.name,r(i)},n.onerror=function(e){console.error(e.message)},n.readAsArrayBuffer(e)},t.prototype.SaveFile=function(){this.Save(this.fileName)},t.prototype.SetFileName=function(e){this.fileName=e},t.prototype.GetFileName=function(){return this.fileName},t}(e.BaseIO);e.FileIO=t}(e.IO||(e.IO={})),e.IO}(XboxInternals||(XboxInternals={}));var XboxInternals;!function(e){!function(e){e.dataBlocksPerHashTreeLevel=new Array(170,28900,4913e3),function(e){e[e.StfsFemale=0]="StfsFemale",e[e.StfsMale=1]="StfsMale"}(e.Sex||(e.Sex={})),e.Sex,function(e){e[e.Zero=0]="Zero",e[e.One=1]="One",e[e.Two=2]="Two"}(e.Level||(e.Level={})),e.Level,function(e){e[e.DevKit=1]="DevKit",e[e.Retail=2]="Retail"}(e.ConsoleType||(e.ConsoleType={})),e.ConsoleType,function(e){e[e.TestKit=1073741824]="TestKit",e[e.RecoveryGenerated=2147483648]="RecoveryGenerated"}(e.ConsoleTypeFlags||(e.ConsoleTypeFlags={})),e.ConsoleTypeFlags,function(e){e[e.CON=1129270816]="CON",e[e.LIVE=1279874629]="LIVE",e[e.PIRS=1346982483]="PIRS"}(e.Magic||(e.Magic={})),e.Magic,function(e){e[e.ConsecutiveBlocks=1]="ConsecutiveBlocks",e[e.Folder=2]="Folder"}(e.FileEntryFlags||(e.FileEntryFlags={})),e.FileEntryFlags,function(e){e[e.None=0]="None",e[e.SystemUpdate=1398100036]="SystemUpdate",e[e.TitleUpdate=1414877252]="TitleUpdate",e[e.SystemUpdateProgressCache=1344557909]="SystemUpdateProgressCache",e[e.TitleUpdateProgressCache=1344558165]="TitleUpdateProgressCache",e[e.TitleContentProgressCache=1344558147]="TitleContentProgressCache"}(e.InstallerType||(e.InstallerType={})),e.InstallerType,function(e){e[e.ArcadeGame=851968]="ArcadeGame",e[e.AvatarAssetPack=32768]="AvatarAssetPack",e[e.AvatarItem=36864]="AvatarItem",e[e.CacheFile=262144]="CacheFile",e[e.CommunityGame=33554432]="CommunityGame",e[e.GameDemo=524288]="GameDemo",e[e.GameOnDemand=28672]="GameOnDemand",e[e.GamerPicture=131072]="GamerPicture",e[e.GamerTitle=655360]="GamerTitle",e[e.GameTrailer=786432]="GameTrailer",e[e.GameVideo=4194304]="GameVideo",e[e.InstalledGame=16384]="InstalledGame",e[e.Installer=720896]="Installer",e[e.IPTVPauseBuffer=8192]="IPTVPauseBuffer",e[e.LicenseStore=983040]="LicenseStore",e[e.MarketPlaceContent=2]="MarketPlaceContent",e[e.Movie=1048576]="Movie",e[e.MusicVideo=3145728]="MusicVideo",e[e.PodcastVideo=5242880]="PodcastVideo",e[e.Profile=65536]="Profile",e[e.Publisher=3]="Publisher",e[e.SavedGame=1]="SavedGame",e[e.StorageDownload=327680]="StorageDownload",e[e.Theme=196608]="Theme",e[e.Video=2097152]="Video",e[e.ViralVideo=6291456]="ViralVideo",e[e.XboxDownload=458752]="XboxDownload",e[e.XboxOriginalGame=20480]="XboxOriginalGame",e[e.XboxSavedGame=393216]="XboxSavedGame",e[e.Xbox360Title=4096]="Xbox360Title",e[e.XNA=917504]="XNA"}(e.ContentType||(e.ContentType={})),e.ContentType,function(e){e[e.Unallocated=0]="Unallocated",e[e.PreviouslyAllocated=64]="PreviouslyAllocated",e[e.Allocated=128]="Allocated",e[e.NewlyAllocated=192]="NewlyAllocated"}(e.BlockStatusLevelZero||(e.BlockStatusLevelZero={})),e.BlockStatusLevelZero,function(e){e[e.EnhancedGDFLayout=64]="EnhancedGDFLayout",e[e.houldBeZeroForDownLevelClients=128]="houldBeZeroForDownLevelClients"}(e.SVODFeatures||(e.SVODFeatures={})),e.SVODFeatures}(e.Stfs||(e.Stfs={})),e.Stfs}(XboxInternals||(XboxInternals={}));var XboxInternals;!function(e){!function(t){!function(e){e[e.Unused=0]="Unused",e[e.Unrestricted=65535]="Unrestricted",e[e.ConsoleProfileLicense=9]="ConsoleProfileLicense",e[e.WindowsProfileLicense=3]="WindowsProfileLicense",e[e.ConsoleLicense=61440]="ConsoleLicense",e[e.MediaFlags=57344]="MediaFlags",e[e.KeyVaultPrivileges=53248]="KeyVaultPrivileges",e[e.HyperVisorFlags=49152]="HyperVisorFlags",e[e.UserPrivileges=45056]="UserPrivileges"}(t.LicenseType||(t.LicenseType={}));var r=t.LicenseType,n=function(){function n(){}return n.prototype.ReadStfsVolumeDescriptorEx=function(t,r){t.SetPosition(r),t.SetEndian(e.IO.EndianType.BigEndian);var n=t.ReadByte(),i=t.ReadByte(),o=t.ReadByte();t.SetEndian(e.IO.EndianType.LittleEndian);var l=t.ReadWord(),s=t.ReadInt24(),a=t.ReadBytes(20);t.SetEndian(e.IO.EndianType.BigEndian);var u=t.ReadInt32(),c=t.ReadInt32(),h={size:n,reserved:i,blockSeperation:o,fileTableBlockCount:l,fileTableBlockNum:s,topHashTableHash:a,allocatedBlockCount:u,unallocatedBlockCount:c};return h},n.prototype.ReadSvodVolumeDescriptorEx=function(t){return t.SetPosition(889),{size:t.ReadByte(),blockCacheElementCount:t.ReadByte(),workerThreadProcessor:t.ReadByte(),workerThreadPriority:t.ReadByte(),rootHash:t.ReadBytes(20),flags:t.ReadByte(),dataBlockCount:t.ReadInt24(e.IO.EndianType.LittleEndian),dataBlockOffset:t.ReadInt24(e.IO.EndianType.LittleEndian),reserved:t.ReadBytes(5)}},n.prototype.WriteStfsVolumeDescriptorEx=function(t,r,n){r.SetPosition(n);var i=2359296;i|=t.blockSeperation[0],r.WriteInt24(i),r.SwapEndian(),r.WriteWord(t.fileTableBlockCount),r.SwapEndian(),r.WriteInt24(t.fileTableBlockNum,e.IO.EndianType.LittleEndian),r.WriteBytes(t.topHashTableHash),r.WriteDword(t.allocatedBlockCount),r.WriteDword(t.unallocatedBlockCount)},n.prototype.WriteCertificateEx=function(e,t,r){t.SetPosition(r),t.WriteWord(e.publicKeyCertificateSize),t.WriteBytes(e.ownerConsoleID),t.WriteString(e.ownerConsolePartNumber,17,!1);var n=e.consoleTypeFlags|e.ownerConsoleType;t.WriteDword(n),t.WriteString(e.dataGeneration,8,!1),t.WriteDword(e.publicExponent),t.WriteBytes(e.publicModulus),t.WriteBytes(e.certificateSignature),t.WriteBytes(e.signature)},n.prototype.LicenseTypeToString=function(e){switch(e){case r.Unused:return"Unused";case r.Unrestricted:return"Unrestricted";case r.ConsoleProfileLicense:return"ConsoleProfileLicense";case r.WindowsProfileLicense:return"WindowsProfileLicense";case r.ConsoleLicense:return"ConsoleLicense";case r.MediaFlags:return"MediaFlags";case r.KeyVaultPrivileges:return"KeyVaultPrivileges";case r.HyperVisorFlags:return"HyperVisorFlags";case r.UserPrivileges:return"UserPrivileges";default:throw"STFS: Invalid 'License Type' value."}},n.prototype.ByteSizeToString=function(e){var t=1,r=1024*t,n=1024*r,i=1024*n;return e>i?e/i+" GB":e>n?e/n+" MB":e>r?e/r+" KB":e+" bytes"},n.prototype.ReadCertificateEx=function(e,r){e.SetPosition(r);var n=e.ReadWord(),i=e.ReadBytes(5),o=e.ReadString(17),l=e.ReadDword(),s=3&l,a=4294967292&l;if(s!=t.ConsoleType.DevKit&&s!=t.ConsoleType.Retail)throw"STFS: Invalid console type.";var u=e.ReadString(8),c=e.ReadDword(),h=e.ReadBytes(128),f=e.ReadBytes(256),d=e.ReadBytes(16);return{publicKeyCertificateSize:n,ownerConsoleID:i,ownerConsolePartNumber:o,ownerConsoleType:s,consoleTypeFlags:a,dataGeneration:u,publicExponent:c,publicModulus:h,certificateSignature:f,signature:d}},n}();t.StfsDefinitions=n}(e.Stfs||(e.Stfs={})),e.Stfs}(XboxInternals||(XboxInternals={}));var XboxInternals;!function(e){!function(e){!function(e){e[e.CarryableCarryable=1100]="CarryableCarryable",e[e.CarryableFirst=1100]="CarryableFirst",e[e.CarryableLast=1100]="CarryableLast",e[e.CostumeCasualSuit=104]="CostumeCasualSuit",e[e.CostumeCostume=105]="CostumeCostume",e[e.CostumeFirst=100]="CostumeFirst",e[e.CostumeFormalSuit=103]="CostumeFormalSuit",e[e.CostumeLast=106]="CostumeLast",e[e.CostumeLongDress=101]="CostumeLongDress",e[e.CostumeShortDress=100]="CostumeShortDress",e[e.EarringsDanglers=903]="EarringsDanglers",e[e.EarringsFirst=900]="EarringsFirst",e[e.EarringsLargehoops=907]="EarringsLargehoops",e[e.EarringsLast=907]="EarringsLast",e[e.EarringsSingleDangler=902]="EarringsSingleDangler",e[e.EarringsSingleLargeHoop=906]="EarringsSingleLargeHoop",e[e.EarringsSingleSmallHoop=904]="EarringsSingleSmallHoop",e[e.EarringsSingleStud=900]="EarringsSingleStud",e[e.EarringsSmallHoops=905]="EarringsSmallHoops",e[e.EarringsStuds=901]="EarringsStuds",e[e.GlassesCostume=702]="GlassesCostume",e[e.GlassesFirst=700]="GlassesFirst",e[e.GlassesGlasses=700]="GlassesGlasses",e[e.GlassesLast=702]="GlassesLast",e[e.GlassesSunglasses=701]="GlassesSunglasses",e[e.GlovesFingerless=600]="GlovesFingerless",e[e.GlovesFirst=600]="GlovesFirst",e[e.GlovesFullFingered=601]="GlovesFullFingered",e[e.GlovesLast=601]="GlovesLast",e[e.HatBaseballCap=502]="HatBaseballCap",e[e.HatBeanie=500]="HatBeanie",e[e.HatBearskin=508]="HatBearskin",e[e.HatBrimmed=504]="HatBrimmed",e[e.HatCostume=507]="HatCostume",e[e.HatFez=505]="HatFez",e[e.HatFirst=500]="HatFirst",e[e.HatFlatCap=501]="HatFlatCap",e[e.HatHeadwrap=506]="HatHeadwrap",e[e.HatHelmet=509]="HatHelmet",e[e.HatLast=509]="HatLast",e[e.HatPeakCap=503]="HatPeakCap",e[e.RingFirst=1e3]="RingFirst",e[e.RingLast=1002]="RingLast",e[e.RingLeft=1001]="RingLeft",e[e.RingRight=1e3]="RingRight",e[e.ShirtCoat=210]="ShirtCoat",e[e.ShirtFirst=200]="ShirtFirst",e[e.ShirtHoodie=208]="ShirtHoodie",e[e.ShirtJacket=209]="ShirtJacket",e[e.ShirtLast=210]="ShirtLast",e[e.ShirtLongSleeveShirt=206]="ShirtLongSleeveShirt",e[e.ShirtLongSleeveTee=204]="ShirtLongSleeveTee",e[e.ShirtPolo=203]="ShirtPolo",e[e.ShirtShortSleeveShirt=205]="ShirtShortSleeveShirt",e[e.ShirtSportsTee=200]="ShirtSportsTee",e[e.ShirtSweater=207]="ShirtSweater",e[e.ShirtTee=201]="ShirtTee",e[e.ShirtVest=202]="ShirtVest",e[e.ShoesCostume=407]="ShoesCostume",e[e.ShoesFirst=400]="ShoesFirst",e[e.ShoesFormal=403]="ShoesFormal",e[e.ShoesHeels=401]="ShoesHeels",e[e.ShoesHighBoots=406]="ShoesHighBoots",e[e.ShoesLast=407]="ShoesLast",e[e.ShoesPumps=402]="ShoesPumps",e[e.ShoesSandals=400]="ShoesSandals",e[e.ShoesShortBoots=405]="ShoesShortBoots",e[e.ShoesTrainers=404]="ShoesTrainers",e[e.TrousersCargo=305]="TrousersCargo",e[e.TrousersFirst=300]="TrousersFirst",e[e.TrousersHotpants=300]="TrousersHotpants",e[e.TrousersJeans=306]="TrousersJeans",e[e.TrousersKilt=308]="TrousersKilt",e[e.TrousersLast=309]="TrousersLast",e[e.TrousersLeggings=303]="TrousersLeggings",e[e.TrousersLongShorts=302]="TrousersLongShorts",e[e.TrousersLongSkirt=309]="TrousersLongSkirt",e[e.TrousersShorts=301]="TrousersShorts",e[e.TrousersShortSkirt=307]="TrousersShortSkirt",e[e.TrousersTrousers=304]="TrousersTrousers",e[e.WristwearBands=802]="WristwearBands",e[e.WristwearBracelet=800]="WristwearBracelet",e[e.WristwearFirst=800]="WristwearFirst",e[e.WristwearLast=803]="WristwearLast",e[e.WristwearSweatbands=803]="WristwearSweatbands",e[e.WristwearWatch=801]="WristwearWatch"}(e.AssetSubcategory||(e.AssetSubcategory={})),e.AssetSubcategory,function(e){e[e.Component=1]="Component",e[e.Texture=2]="Texture",e[e.ShapeOverride=3]="ShapeOverride",e[e.Animation=4]="Animation",e[e.ShapeOverridePost=5]="ShapeOverridePost"}(e.BinaryAssetType||(e.BinaryAssetType={})),e.BinaryAssetType,function(e){e[e.Nxe=1]="Nxe",e[e.Natal=0]="Natal",e[e.NxeAndNatal=1]="NxeAndNatal"}(e.SkeletonVersion||(e.SkeletonVersion={})),e.SkeletonVersion,function(e){e[e.Male=1]="Male",e[e.Female=0]="Female",e[e.Both=1]="Both"}(e.AssetGender||(e.AssetGender={})),e.AssetGender,function(e){e[e.STRBAnimation=1]="STRBAnimation",e[e.STRBAssetMetadata=6]="STRBAssetMetadata",e[e.STRBAssetMetadataVersioned=8]="STRBAssetMetadataVersioned",e[e.STRBCustomColorTable=7]="STRBCustomColorTable",e[e.STRBEof=-1]="STRBEof",e[e.STRBInvalid=0]="STRBInvalid",e[e.STRBModel=3]="STRBModel",e[e.STRBShapeOverrides=4]="STRBShapeOverrides",e[e.STRBSkeleton=5]="STRBSkeleton",e[e.STRBTexture=2]="STRBTexture"}(e.STRRBBlockId||(e.STRRBBlockId={})),e.STRRBBlockId}(e.AvatarAsset||(e.AvatarAsset={})),e.AvatarAsset}(XboxInternals||(XboxInternals={}));var sha1;!function(e){function t(e,t){return e<<t|e>>>32-t}function r(e){var r,n,l=1732584193,s=4023233417,a=2562383102,u=271733878,c=3285377520,h=e.length,f=h<<3,d=f+65,p=Math.ceil(d/512)<<9,g=p>>>3,m=g>>>2,v=new o(m),y=v.bytes,b=new Uint32Array(80);for(r=0;h>r;++r)y[r]=e[r];for(y[h]=128,v.set(m-2,Math.floor(f/i)),v.set(m-1,4294967295&f),r=0;m>r;r+=16){for(n=0;16>n;++n)b[n]=v.get(r+n);for(;80>n;++n)b[n]=t(b[n-3]^b[n-8]^b[n-14]^b[n-16],1);var x,C,w,L=l,S=s,k=a,T=u,M=c;for(n=0;80>n;++n)20>n?(x=S&k|~S&T,C=1518500249):40>n?(x=S^k^T,C=1859775393):60>n?(x=S&k^S&T^k&T,C=2400959708):(x=S^k^T,C=3395469782),w=4294967295&t(L,5)+x+M+C+b[n],M=T,T=k,k=t(S,30),S=L,L=w;l=4294967295&l+L,s=4294967295&s+S,a=4294967295&a+k,u=4294967295&u+T,c=4294967295&c+M}for(var A=new Uint8Array(20),r=0;r<A.length;r++){var D;D=4>r?l:8>r?s:12>r?a:16>r?u:c,A[r]=255&D>>>8*(3-r%4)}return A}var n=Math.pow(2,24),i=Math.pow(2,32),o=function(){function e(e){this.bytes=new Uint8Array(e<<2)}return e.prototype.get=function(e){return e<<=2,this.bytes[e]*n+(this.bytes[e+1]<<16|this.bytes[e+2]<<8|this.bytes[e+3])},e.prototype.set=function(e,t){var r=Math.floor(t/n),i=t-r*n;e<<=2,this.bytes[e]=r,this.bytes[e+1]=i>>16,this.bytes[e+2]=255&i>>8,this.bytes[e+3]=255&i},e}();e.hash=r}(sha1||(sha1={}));var XboxInternals;!function(e){!function(t){!function(e){e[e.MetadataIsPEC=1]="MetadataIsPEC",e[e.MetadataSkipRead=2]="MetadataSkipRead",e[e.MetadataDontFreeThumbnails=4]="MetadataDontFreeThumbnails"}(t.XContentFlags||(t.XContentFlags={}));var r=t.XContentFlags;!function(e){e[e.FileHeadersNotReady=1179208776]="FileHeadersNotReady",e[e.NewFolder=1718578276]="NewFolder",e[e.NewFolderResum_Attempt1=1718578225]="NewFolderResum_Attempt1",e[e.NewFolderResumeAttempt2=1718578226]="NewFolderResumeAttempt2",e[e.NewFolderResumeAttemptUnknown=1718578239]="NewFolderResumeAttemptUnknown",e[e.NewFolderResumeAttemptSpecific=1718578240]="NewFolderResumeAttemptSpecific"}(t.OnlineContentResumeState||(t.OnlineContentResumeState={})),t.OnlineContentResumeState,function(e){e[e.FileSystemSTFS=0]="FileSystemSTFS",e[e.FileSystemSVOD=1]="FileSystemSVOD",e[e.FileSystemFATX=2]="FileSystemFATX"}(t.FileSystem||(t.FileSystem={}));var n=t.FileSystem,i=function(i){function o(e,t){"undefined"==typeof t&&(t=0),this.io=e,this.readMetadata(),i.call(this)}return __extends(o,i),o.prototype.readMetadata=function(){if(this.io.SetPosition(0),0==(this.flags&r.MetadataIsPEC)){if(this.magic=this.io.ReadDword(),this.magic==t.Magic.CON)this.certificate=this.ReadCertificateEx(this.io,4);else{if(this.magic!=t.Magic.LIVE&&this.magic!=t.Magic.PIRS)throw"XContentHeader: Content signature of type 0x"+this.magic+" is invalid";this.packageSignature=this.io.ReadBytes(256)}this.io.SetPosition(556),this.licenseData=new Array(16);for(var e=0;16>e;e++)switch(this.io.SetPosition(this.io.GetPosition()+8),this.licenseData[e]={type:0,data:0,bits:this.io.ReadDword(),flags:this.io.ReadDword()},this.licenseData[e].type){case 0:case 65535:case 9:case 3:case 61440:case 57344:case 53248:case 49152:case 45056:break;default:throw"XContentHeader: Invalid license type at index "+e+"."}if(this.headerHash=this.io.ReadBytes(20),this.headerSize=this.io.ReadDword(),this.contentType=this.io.ReadDword(),this.metaDataVersion=this.io.ReadDword(),this.contentSize=0,this.io.SetPosition(this.io.GetPosition()+8),this.mediaID=this.io.ReadDword(),this.version=this.io.ReadDword(),this.baseVersion=this.io.ReadDword(),this.titleID=this.io.ReadDword(),this.platform=this.io.ReadByte(),this.executableType=this.io.ReadByte(),this.discNumber=this.io.ReadByte(),this.discInSet=this.io.ReadByte(),this.savegameID=this.io.ReadDword(),this.consoleID=this.io.ReadBytes(5),this.profileID=this.io.ReadBytes(8),this.io.SetPosition(937),this.fileSystem=this.io.ReadDword(),this.fileSystem>1)throw"XContentHeader: Invalid file system. Only STFS and SVOD are supported.";if(this.fileSystem==n.FileSystemSTFS?this.stfsVolumeDescriptor=this.ReadStfsVolumeDescriptorEx(this.io,889):(this.fileSystem=n.FileSystemSVOD)&&(this.svodVolumeDescriptor=this.ReadSvodVolumeDescriptorEx(this.io)),this.dataFileCount=this.io.ReadDword(),this.dataFileCombinedSize=0,this.io.SetPosition(this.io.GetPosition()+8),this.contentType==t.ContentType.AvatarItem){if(this.io.SetPosition(985),this.io.SwapEndian(),this.subCategory=this.io.ReadDword(),this.colorizable=this.io.ReadDword(),this.io.SwapEndian(),this.guid=this.io.ReadBytes(16),this.skeletonVersion=this.io.ReadByte()[0],this.skeletonVersion<1||this.skeletonVersion>3)throw"XContentHeader: Invalid skeleton version."}else this.contentType==t.ContentType.Video&&(this.io.SetPosition(985),this.seriesID=this.io.ReadBytes(16),this.seasonID=this.io.ReadBytes(16),this.seasonNumber=this.io.ReadWord(),this.episodeNumber=this.io.ReadWord());this.io.SetPosition(1021),this.deviceID=this.io.ReadBytes(20),this.displayName=this.io.ReadWString(128),this.io.SetPosition(3345),this.displayDescription=this.io.ReadWString(128),this.io.SetPosition(5649),this.publisherName=this.io.ReadWString(128),this.io.SetPosition(5777),this.titleName=this.io.ReadWString(128),this.io.SetPosition(5905),this.transferFlag=this.io.ReadByte(),this.thumbnailImageSize=this.io.ReadDword(),this.titleThumbnailImageSize=this.io.ReadDword(),this.thumbnailImage=this.io.ReadBytes(this.thumbnailImageSize),this.io.SetPosition(22298)}else this.ReadCertificateEx(this.io,0),this.headerHash=this.io.ReadBytes(20),this.ReadStfsVolumeDescriptorEx(this.io,580),this.io.SetPosition(620),this.profileID=this.io.ReadBytes(8),this.enabled=this.io.ReadByte()[0]>=1,this.consoleID=this.io.ReadBytes(5),this.headerSize=4096},o.prototype.WriteVolumeDescriptor=function(){this.fileSystem==n.FileSystemSTFS&&this.WriteStfsVolumeDescriptorEx(this.stfsVolumeDescriptor,this.io,this.flags&r.MetadataIsPEC?580:889)},o.prototype.WriteMetaData=function(){return},o.prototype.ResignHeader=function(){var t,n,i,l,s;this.flags&r.MetadataIsPEC?(t=572,i=552,n=3524,l=572,s=629):(t=836,i=812,n=280,l=556,s=876);var a=4294963200&this.headerSize+4095;a=this.io.buffer.byteLength<a?this.io.buffer.byteLength:a;var u=a-t;this.io.SetPosition(s),this.io.WriteBytes(this.certificate.ownerConsoleID),this.io.SetPosition(t);var c=this.io.ReadBytes(u);this.headerHash=sha1.hash(c),this.io.SetPosition(i),this.io.WriteBytes(this.headerHash),this.io.SetPosition(l);var h=sha1.hash(this.io.ReadBytes(n)),f=new RSAKey;f.setPrivateEx("a31d6ce5fa95fde89021fad10c64192b86589b172b1005b8d1f84cef534cd54e5cae86ef927b90d1e062fd7c54559ee0e7befa3f9e156f6c384eaf070c61ab515e2353141888cb6fcbc5d630f406ed2423ef256d009177249be5a3c02790c297f7749d6f17837eb537de51e8d71ce156d956c8c3c3209d64c32f8c9192306fdb","00010001","51ec1f9d5626c2fc10a66764cb3a6d4da1e74ea842f0f4fdfa66efc78e102fe41ca31dd0ce392ec3192dd0587479ac08e790c1ac2dc6eb47e83dcf4c6dff5165d46ebd0f15793795c4af909e2b508a0a224ab341e5898073cdfa2102f5dd30dd072a6f340781977eb2fb72e9eac18839ac482ba84dfcd7ed9bf9dec245934c4c","cce75dfe72b6fde71de31a0eac337ab921e88a849bda9f1e5834687ab11d7e1c1852657b978ea76a9dee5a77523b718f33d0495ec330397236bf1dd9f224e871","cbca5874d403629306501f42f6aa5936a7a1f3975c9ac86a27cf85052a66416a7f2f84c81813c61d8dc7322f72193fa4ed71e761c0cf61ae8ba068a77d83230b","4cca74e67435724858621114e8a24e5eed7f49d252da8701874af4d0ee69c026655313e752b04abbe13e3fb7322146f8c5114d3def66b650c085b579458f6171","afdc46e7528a3547a11c054e392499e64354cbabe3db22761132d09cbb911084818b152fc32f5538edbf673c705eff8028f3b173b6fa7f562be1da4e274ec22f","286abbd19395941a6eedd70ec0612bc2efe1863d3412886f94a4486ec9871e46004600528e9f47c08cabbc49ac5b13f2ec278d1b6e5106a6f1621aeb782e8848"),this.certificate.signature=o.Uint8ArrayFromHex(f.signHashWithSHA1(this.Uint8ArrayToHexString(h))),this.certificate.publicKeyCertificateSize=424,this.certificate.ownerConsoleID=new Uint8Array([9,18,186,38,227]),this.certificate.ownerConsolePartNumber="X803395-001",this.certificate.ownerConsoleType=e.Stfs.ConsoleType.Retail,this.certificate.dataGeneration="09-18-06",this.certificate.publicExponent=65537,this.certificate.publicModulus=new Uint8Array([195,47,140,145,146,48,111,219,217,86,200,195,195,32,157,100,55,222,81,232,215,28,225,86,247,116,157,111,23,131,126,181,155,229,163,192,39,144,194,151,35,239,37,109,0,145,119,36,203,197,214,48,244,6,237,36,94,35,83,20,24,136,203,111,56,78,175,7,12,97,171,81,231,190,250,63,158,21,111,108,224,98,253,124,84,85,158,224,92,174,134,239,146,123,144,209,209,248,76,239,83,76,213,78,134,88,155,23,43,16,5,184,144,33,250,209,12,100,25,43,163,29,108,229,250,149,253,232]),this.certificate.certificateSignature=new Uint8Array([249,112,13,42,137,57,158,213,78,101,135,68,249,79,32,144,137,65,55,80,46,248,48,8,204,110,205,209,87,231,195,183,150,176,42,128,89,203,126,67,251,219,126,12,239,108,94,0,11,30,135,225,2,100,167,8,36,50,185,83,21,0,233,227,83,12,21,225,93,89,198,9,171,209,115,181,238,197,231,80,188,194,178,37,152,186,160,10,132,244,248,45,26,210,201,127,220,207,93,2,33,154,37,224,105,17,108,252,136,6,1,73,244,116,64,141,216,145,219,131,201,96,206,13,127,151,170,42,54,165,240,12,16,99,233,169,57,79,187,71,108,68,34,241,190,58,73,1,237,91,71,0,67,33,189,251,178,149,154,95,180,70,244,167,18,36,75,11,127,184,142,187,82,131,34,88,30,6,183,173,122,58,22,126,200,215,55,129,158,138,242,196,102,8,136,254,167,14,143,157,135,95,14,123,72,154,6,98,247,36,37,205,176,79,115,104,151,12,228,173,232,85,154,180,250,101,181,163,88,254,129,64,84,170,31,0,42,241,221,138,31,69,78,157,255,130,70,90,90,144,37,160,88,15,242,39]),this.WriteCertificate()},o.Uint8ArrayFromHex=function(e){for(var t=new Uint8Array(e.length/2),r=0;r<e.length-1;r+=2)t[r/2]=parseInt(e.substr(r,2),16);return t},o.BnQw_SwapDwQwLeBe=function(e){if(0!=e.length%8)throw"STFS: length is not divisible by 8.\n";for(var t=new Uint8Array(e.length),r=0;r<e.length;r+=8){var n=e.length-(r+8);e.length-r;for(var i=7;i>=0;i--)t.set(e.subarray(n+i,n+i+1),r+(7-i))}return t},o.prototype.WriteCertificate=function(){if(this.magic!=t.Magic.CON&&0==(this.flags&r.MetadataIsPEC))throw"XContentHeader: Error writing certificate. Package is strong signed and therefor doesn't have a certificate.";this.WriteCertificateEx(this.certificate,this.io,this.flags&r.MetadataIsPEC?0:4)},o.prototype.Uint8ArrayToHexString=function(e){for(var t="",r=0;r<e.length;r++)t+=(e[r]>15?"":"0")+e[r].toString(16);return t.toUpperCase()},o}(t.StfsDefinitions);t.XContentHeader=i}(e.Stfs||(e.Stfs={})),e.Stfs}(XboxInternals||(XboxInternals={}));var XboxInternals;!function(e){!function(t){var r=function(){function r(e,t){this.io=e,this.ioPassedIn=!0,this.flags=t,this.metaData=null,this.Init()}return r.prototype.Init=function(){if(this.flags&s.StfsPackageCreate){for(var e=this.flags&s.StfsPackagePEC?this.flags&s.StfsPackageFemale?8192:4096:this.flags&s.StfsPackageFemale?45056:40960,t=new Uint8Array(4096),r=0;r<(e>>12)+(this.flags&s.StfsPackageFemale?1:2)+2;r++)this.io.WriteBytes(t);this.io.SetPosition(this.flags&s.StfsPackagePEC?582:891),this.io.WriteByte(new Uint8Array([(this.flags&s.StfsPackageFemale)>>2]))}this.Parse()},r.prototype.Parse=function(){if(this.metaData=new t.XContentHeader(this.io,this.flags&s.StfsPackagePEC),this.metaData.fileSystem!=t.FileSystem.FileSystemSTFS&&0==(this.flags&s.StfsPackagePEC))throw"STFS: invalid file system header.";this.packageSex=1&~this.metaData.stfsVolumeDescriptor.blockSeperation[0],this.blockStep=this.packageSex==t.Sex.StfsFemale?[171,29071]:[172,29242],this.firstHashTableAddress=4294963200&this.metaData.headerSize+4095,this.tablesPerLevel=Array(3),this.tablesPerLevel[0]=Math.floor(this.metaData.stfsVolumeDescriptor.allocatedBlockCount/170)+(0!=this.metaData.stfsVolumeDescriptor.allocatedBlockCount%170?1:0),this.tablesPerLevel[1]=Math.floor(this.tablesPerLevel[0]/170)+(0!=this.tablesPerLevel[0]%170&&this.metaData.stfsVolumeDescriptor.allocatedBlockCount>170?1:0),this.tablesPerLevel[2]=Math.floor(this.tablesPerLevel[1]/170)+(0!=this.tablesPerLevel[1]%170&&this.metaData.stfsVolumeDescriptor.allocatedBlockCount>28900?1:0),this.topLevel=this.CalculateTopLevel(),this.topTable=new l,this.topTable.trueBlockNumber=this.ComputeLevelNBackingHashBlockNumber(0,this.topLevel),this.topTable.level=this.topLevel;var e=(this.topTable.trueBlockNumber<<12)+this.firstHashTableAddress;this.topTable.addressInFile=e+((2&this.metaData.stfsVolumeDescriptor.blockSeperation[0])<<11),this.io.SetPosition(this.topTable.addressInFile);var r=[1,170,28900];this.topTable.entryCount=Math.floor(this.metaData.stfsVolumeDescriptor.allocatedBlockCount/r[this.topLevel]),this.metaData.stfsVolumeDescriptor.allocatedBlockCount>28900&&0!=this.metaData.stfsVolumeDescriptor.allocatedBlockCount%28900?this.topTable.entryCount++:this.metaData.stfsVolumeDescriptor.allocatedBlockCount>170&&0!=this.metaData.stfsVolumeDescriptor.allocatedBlockCount%170&&this.topTable.entryCount++,this.topTable.entries=Array(this.topTable.entryCount);for(var o=0;o<this.topTable.entryCount;o++)this.topTable.entries[o]={blockHash:this.io.ReadBytes(20),status:this.io.ReadByte(),nextBlock:this.io.ReadInt24()};var a=new n;a.pathIndicator=65535,a.name="Root",a.entryIndex=65535,this.fileListing=new i,this.fileListing.folder=a,this.ReadFileListing()},r.prototype.PrintFileListing=function(e,t){"undefined"==typeof e&&(e=null),"undefined"==typeof t&&(t=""),null==e&&(e=this.fileListing),console.log(t,e.folder.name),t+="    ";for(var r=0;r<e.fileEntries.length;r++)console.log(t,e.fileEntries[r].name);for(var r=0;r<e.folderEntries.length;r++)this.PrintFileListing(e.folderEntries[r],t+"    ")},r.prototype.PrintFileListingExtended=function(e,t){"undefined"==typeof e&&(e=null),"undefined"==typeof t&&(t=""),null==e&&(e=this.fileListing),console.log(t,e.folder.name),t+="    ";for(var r=0;r<e.fileEntries.length;r++)console.log(t,e.fileEntries[r].name);for(var r=0;r<e.folderEntries.length;r++)this.PrintFileListing(e.folderEntries[r],t+"    ")},r.prototype.GetFileListing=function(e){return e&&this.ReadFileListing(),this.fileListing},r.prototype.GetFileMagicFromPath=function(e){return this.GetFileMagic(this.GetFileEntryFromPath(e))},r.prototype.GetFileMagic=function(e){return e.fileSize<4?0:(this.io.SetPosition(this.BlockToAddress(e.startingBlockNum)),this.io.ReadDword())},r.prototype.IsPEC=function(){return 1==(this.flags&s.StfsPackagePEC)},r.prototype.Resign=function(){this.metaData.ResignHeader()},r.prototype.ReadFileListing=function(){this.fileListing.fileEntries.length=0,this.fileListing.folderEntries.length=0;
var t=new n;t.startingBlockNum=this.metaData.stfsVolumeDescriptor.fileTableBlockNum,t.fileSize=4096*this.metaData.stfsVolumeDescriptor.fileTableBlockCount;for(var r,o=t.startingBlockNum,l=new i,s=0;s<this.metaData.stfsVolumeDescriptor.fileTableBlockCount;s++){r=this.BlockToAddress(o),this.io.SetPosition(r);for(var a=0;64>a;a++){var u=new n;if(u.fileEntryAddress=r+64*a,u.entryIndex=64*s+a,u.name=this.io.ReadString(40),u.name.length,u.nameLen=this.io.ReadByte(),0!=(63&u.nameLen[0])){if(0==u.name.length)break;u.blocksForFile=this.io.ReadInt24(e.IO.EndianType.LittleEndian),this.io.SetPosition(this.io.GetPosition()+3),u.startingBlockNum=this.io.ReadInt24(e.IO.EndianType.LittleEndian),u.pathIndicator=this.io.ReadWord(),u.fileSize=this.io.ReadDword(),u.createdTimeStamp=this.io.ReadDword(),u.accessTimeStamp=this.io.ReadDword(),u.flags=new Uint8Array(1),u.flags[0]=u.nameLen[0]>>6,u.nameLen[0]&=63,l.fileEntries.push(u)}else this.io.SetPosition(r+64*(a+1))}o=this.GetBlockHashEntry(o).nextBlock}this.fileListing=this.AddToListing(l,this.fileListing),this.writtenToFile=this.fileListing},r.prototype.AddToListing=function(e,t){for(var r=0;r<e.fileEntries.length;r++){var n=2==(2&e.fileEntries[r].flags[0]);if(e.fileEntries[r].pathIndicator==t.folder.entryIndex)if(n){if(e.fileEntries[r].entryIndex!=t.folder.entryIndex){var o=new i;o.folder=e.fileEntries[r],t.folderEntries.push(o)}}else t.fileEntries.push(e.fileEntries[r])}for(var r=0;r<t.folderEntries.length;r++)t.folderEntries[r]=this.AddToListing(e,t.folderEntries[r]);return t},r.prototype.CalculateTopLevel=function(){if(this.metaData.stfsVolumeDescriptor.allocatedBlockCount<=170)return t.Level.Zero;if(this.metaData.stfsVolumeDescriptor.allocatedBlockCount<=28900)return t.Level.One;if(this.metaData.stfsVolumeDescriptor.allocatedBlockCount<=4913e3)return t.Level.Two;throw"STFS: invalid number of allocated blocks."},r.prototype.ComputeLevelNBackingHashBlockNumber=function(e,r){switch(r){case t.Level.Zero:return this.ComputeLevel0BackingHashBlockNumber(e);case t.Level.One:return this.ComputeLevel1BackingHashBlockNumber(e);case t.Level.Two:return this.ComputeLevel2BackingHashBlockNumber(e);default:throw"STFS: invalid level."}},r.prototype.WriteUint32Array=function(e){for(var t=0;t<e.length;t++)this.io.WriteDword(e[t])},r.prototype.HashBlock=function(e){return sha1.hash(e)},r.prototype.ComputeLevel0BackingHashBlockNumber=function(e){if(170>e)return 0;var t=Math.floor(e/170)*this.blockStep[0];return t+=Math.floor(e/28900)+1<<this.packageSex,0==Math.floor(e/28900)?t:t+(1<<this.packageSex)},r.prototype.ComputeLevel1BackingHashBlockNumber=function(e){return 28900>e?this.blockStep[0]:(1<<this.packageSex)+Math.floor(e/28900)*this.blockStep[1]},r.prototype.ComputeLevel2BackingHashBlockNumber=function(){return this.blockStep[2]},r.prototype.ComputeBackingDataBlockNumber=function(e){var t=(Math.floor((e+170)/170)<<this.packageSex)+e;return 170>e?t:28900>e?t+(Math.floor((e+28900)/28900)<<this.packageSex):(1<<this.packageSex)+(t+(Math.floor((e+28900)/28900)<<this.packageSex))},r.prototype.BlockToAddress=function(e){if(e>=r.INT24_MAX)throw"STFS: block number must be less than 0xFFFFFF.";return(this.ComputeBackingDataBlockNumber(e)<<12)+this.firstHashTableAddress},r.prototype.GetHashAddressOfBlock=function(e){if(e>=this.metaData.stfsVolumeDescriptor.allocatedBlockCount)throw"STFS: reference to illegal block number.";var t=(this.ComputeLevel0BackingHashBlockNumber(e)<<12)+this.firstHashTableAddress;switch(t+=24*(e%170),this.topLevel){case 0:t+=(2&this.metaData.stfsVolumeDescriptor.blockSeperation[0])<<11;break;case 1:t+=(64&this.topTable.entries[Math.floor(e/170)].status[0])<<6;break;case 2:var r=(64&this.topTable.entries[Math.floor(e/28900)].status[0])<<6,n=(this.ComputeLevel1BackingHashBlockNumber(e)<<12)+this.firstHashTableAddress+r+24*(e%170);this.io.SetPosition(n+20),t+=(64&this.io.ReadByte()[0])<<6}return t},r.prototype.GetBlockHashEntry=function(e){if(e>=this.metaData.stfsVolumeDescriptor.allocatedBlockCount)throw"STFS: reference to illegal block number.";return this.io.SetPosition(this.GetHashAddressOfBlock(e)),{blockHash:this.io.ReadBytes(20),status:this.io.ReadByte(),nextBlock:this.io.ReadInt24()}},r.prototype.GetFileEntryFromPath=function(e,t,r){"undefined"==typeof t&&(t=!1),"undefined"==typeof r&&(r=null);var n=this.GetFileEntry(e.split("\\"),this.fileListing,r,null!=r,t);if(0==n.nameLen[0])throw"STFS: file entry "+e+" cannot be found in the package.";return n},r.prototype.GetFileEntry=function(e,t,r,i,o){if("undefined"==typeof r&&(r=null),"undefined"==typeof i&&(i=!1),"undefined"==typeof o&&(o=!1),1==e.length){for(var l=0;l<t.fileEntries.length;l++)if(t.fileEntries[l].name==e[0])return i&&(t.fileEntries[l]=r,this.io.SetPosition(t.fileEntries[l].fileEntryAddress),this.WriteFileEntry(t.fileEntries[l])),t.fileEntries[l];if(o)for(var l=0;l<t.folderEntries.length;l++)if(t.folderEntries[l].folder.name==e[0])return i&&(t.folderEntries[l].folder=r,this.io.SetPosition(t.folderEntries[l].folder.fileEntryAddress),this.WriteFileEntry(t.folderEntries[l].folder)),t.folderEntries[l].folder}else for(var l=0;l<t.folderEntries.length;l++)if(t.folderEntries[l].folder.name==e[0]){var s=e.indexOf(e[0],0);return void 0!=s&&e.splice(s,1),this.GetFileEntry(e,t.folderEntries[l],r,i,o)}var a=new n;return a.nameLen=new Uint8Array([0]),a},r.prototype.WriteFileEntry=function(t){if(t.nameLen=new Uint8Array([t.name.length]),t.nameLen[0]>40)throw"STFS: file entry name length cannot be  greater than 40(0x28) characters.";var r=t.nameLen[0]|t.flags[0]<<6,n=this.io.GetEndian();this.io.SetEndian(e.IO.EndianType.BigEndian),this.io.WriteString(t.name,40,!1),this.io.WriteByte(new Uint8Array([r])),this.io.WriteInt24(t.blocksForFile,e.IO.EndianType.LittleEndian),this.io.WriteInt24(t.blocksForFile,e.IO.EndianType.LittleEndian),this.io.WriteInt24(t.startingBlockNum,e.IO.EndianType.LittleEndian),this.io.WriteWord(t.pathIndicator),this.io.WriteDword(t.fileSize),this.io.WriteDword(t.createdTimeStamp),this.io.WriteDword(t.accessTimeStamp),this.io.SetEndian(n)},r.prototype.ExtractBlock=function(e,t){if("undefined"==typeof t&&(t=4096),e>=this.metaData.stfsVolumeDescriptor.allocatedBlockCount)throw"STFS: reference to illegal block number.";if(t>4096)throw"STFS: length cannot be greater 0x1000";return this.io.SetPosition(this.BlockToAddress(e)),this.io.ReadBytes(t)},r.prototype.ExtractFileFromPath=function(e,t){"undefined"==typeof t&&(t=null);var r=this.GetFileEntryFromPath(e);return this.ExtractFile(r,t)},r.prototype.ExtractFile=function(t,r){if("undefined"==typeof r&&(r=null),0==t.nameLen[0])throw"STFS: file '"+t.name+"' doesn't exist in the package.";(new Date).getTime();var n=t.fileSize,i=new e.IO.FileIO(new ArrayBuffer(n));if(i.SetFileName(t.name),0==n)return null!=r&&r(100),i;if(1==(1&t.flags[0])){new ArrayBuffer(n);var o=this.BlockToAddress(t.startingBlockNum);this.io.SetPosition(o);var l=this.ComputeLevel0BackingHashBlockNumber(t.startingBlockNum)+this.blockStep[0]-(o-this.firstHashTableAddress>>12);if(t.blocksForFile<=l)return i.WriteBytes(this.io.ReadBytes(t.fileSize)),null!=r&&r(100),i;i.WriteBytes(this.io.ReadBytes(l<<12)),null!=r&&r(Math.round(100/t.blocksForFile*l));for(var s=t.fileSize-(l<<12);s>=696320;){var a=this.io.GetPosition();this.io.SetPosition(a+this.GetHashTableSkipSize(a)),i.WriteBytes(this.io.ReadBytes(696320)),s-=696320,l+=170,null!=r&&r(Math.round(100/t.blocksForFile*l))}if(0!=s){var a=this.io.GetPosition();this.io.SetPosition(a+this.GetHashTableSkipSize(a)),i.WriteBytes(this.io.ReadBytes(s)),null!=r&&r(100)}return i}var u=Math.floor(n/4096);n-=4096*u;for(var c=t.startingBlockNum,h=0;u>h;h++)i.WriteBytes(this.ExtractBlock(c)),c=this.GetBlockHashEntry(c).nextBlock,null!=r&&r(Math.round(100/t.blocksForFile*(h+1)));return 0!=n&&(i.WriteBytes(this.ExtractBlock(c,n)),null!=r&&r(100)),i},r.prototype.SetBlockStatus=function(e,t){if(e>=this.metaData.stfsVolumeDescriptor.allocatedBlockCount)throw"STFS: Reference to illegal block number.";var r=this.GetHashAddressOfBlock(e)+20;this.io.SetPosition(r),this.io.WriteByte(new Uint8Array(t))},r.prototype.RemoveFileFromPath=function(e){this.RemoveFile(this.GetFileEntryFromPath(e))},r.prototype.RemoveFile=function(e){for(var r=!1,n=this.GenerateRawFileListing(this.fileListing,[],[]),i=n.outFiles,o=n.outFolders,l=0;l<i.length;l++)if(i[l].name==e.name&&i[l].pathIndicator==e.pathIndicator){i.splice(l,1),r=!0;break}if(!r)throw"STFS: File could not be deleted because it doesn't exist in the package.";for(var s=e.startingBlockNum;16777215!=s;)this.SetBlockStatus(s,t.BlockStatusLevelZero.Unallocated),s=this.GetBlockHashEntry(s).nextBlock;this.WriteFileListing(!0,i,o)},r.prototype.GetHashTableSkipSize=function(e){var t=e-this.firstHashTableAddress>>12;return 0==t?4096<<this.packageSex:t==this.blockStep[1]?12288<<this.packageSex:(t>this.blockStep[1]&&(t-=this.blockStep[1]+(1<<this.packageSex)),t==this.blockStep[0]||0==t%this.blockStep[1]?8192<<this.packageSex:4096<<this.packageSex)},r.prototype.FileExists=function(e){var t=this.GetFileEntry(e.split("\\"),this.fileListing);return 0!=t.nameLen[0]},r.prototype.InjectFile=function(e,i,o){if("undefined"==typeof o&&(o=null),this.FileExists(i))throw"STFS: file already exists in the package.";var l,s,a=i.split("\\"),u=a.length;if(u>1){if(s=a[u-1],a=a.splice(u-1,1),l=this.FindDirectoryListing(a,this.fileListing),null==l)throw"STFS: the given folder could not be found."}else s=i,l=this.fileListing;var c=e.buffer.byteLength,h=new n;if(h.name=s,s.length>40)throw"STFS: file entry name length cannot be greater than 40(0x28) characters.";h.fileSize=c,h.flags=new Uint8Array([t.FileEntryFlags.ConsecutiveBlocks]),h.pathIndicator=l.folder.entryIndex,h.startingBlockNum=r.INT24_MAX,h.blocksForFile=(0xfffffff000&c+4095)>>12,h.createdTimeStamp=Date.now(),h.accessTimeStamp=h.createdTimeStamp;for(var f=0,d=r.INT24_MAX,p=0;c>=4096;)f=this.AllocateBlock(),h.startingBlockNum==r.INT24_MAX&&(h.startingBlockNum=f),d!=r.INT24_MAX&&this.SetNextBlock(d,f),d=f,this.io.SetPosition(this.BlockToAddress(f)),this.io.WriteBytes(e.ReadBytes(4096)),c-=4096,o&&o(Math.round(100/h.blocksForFile*++p));if(0!=c&&(f=this.AllocateBlock(),h.startingBlockNum==r.INT24_MAX&&(h.startingBlockNum=f),d!=r.INT24_MAX&&this.SetNextBlock(d,f),this.io.SetPosition(this.BlockToAddress(f)),this.io.WriteBytes(e.ReadBytes(c)),c=0,o&&o(100)),this.SetNextBlock(f,r.INT24_MAX),l.fileEntries.push(h),this.WriteFileListing(),this.topLevel==t.Level.Zero){this.io.SetPosition(this.topTable.addressInFile),this.topTable.entryCount=this.metaData.stfsVolumeDescriptor.allocatedBlockCount;for(var g=0;g<this.topTable.entryCount;g++)this.topTable.entries[g].blockHash=this.io.ReadBytes(20),this.topTable.entries[g].status=this.io.ReadByte(),this.topTable.entries[g].nextBlock=this.io.ReadInt24()}return h},r.prototype.WriteFileListing=function(e,t,n){var i,o;if(e)i=t,o=n;else{var l=this.GenerateRawFileListing(this.fileListing,[],[]);i=l.outFiles,o=l.outFolders}o=o.splice(1);var s={};s[65535]=65535;var a=!1,u=!0,c=this.metaData.stfsVolumeDescriptor.fileTableBlockNum;this.io.SetPosition(this.BlockToAddress(c));for(var h=o.length,f=0;h>f;f++)s[o[f].entryIndex]=f;for(var f=0;f<o.length;f++){if(u)u=!1;else if(0==(f+1)%64){var d;a?(d=this.AllocateBlock(),this.SetNextBlock(c,d)):(d=this.GetBlockHashEntry(c).nextBlock,d==r.INT24_MAX&&(d=this.AllocateBlock(),this.SetNextBlock(c,d),a=!0)),c=d,this.io.SetPosition(this.BlockToAddress(c))}o[f].pathIndicator=s[o[f].pathIndicator],this.WriteFileEntry(o[f])}for(var p=h+i.length,f=h;p>f;f++){if(u)u=!1;else if(0==(f+1)%64){var d;a?(d=this.AllocateBlock(),this.SetNextBlock(c,d)):(d=this.GetBlockHashEntry(c).nextBlock,d==r.INT24_MAX&&(d=this.AllocateBlock(),this.SetNextBlock(c,d),a=!0)),c=d,this.io.SetPosition(this.BlockToAddress(c))}i[f-h].pathIndicator=s[i[f-h].pathIndicator],this.WriteFileEntry(i[f-h])}var g=p%64,m=0;g>0&&(m=64*(64-g));var v=new Uint8Array(m);this.io.WriteBytes(v),this.metaData.stfsVolumeDescriptor.fileTableBlockCount=Math.floor(p/64)+1,0==p%64&&0!=p&&this.metaData.stfsVolumeDescriptor.fileTableBlockCount--,this.metaData.WriteVolumeDescriptor(),this.ReadFileListing()},r.prototype.GenerateRawFileListing=function(e,t,r){for(var n=e.fileEntries.length,i=e.folderEntries.length,o=0;n>o;o++)t.push(e.fileEntries[o]);r.push(e.folder);for(var o=0;i>o;o++){var l=this.GenerateRawFileListing(e.folderEntries[o],t,r);t=l.outFiles,r=l.outFolders}return{outFiles:t,outFolders:r}},r.prototype.SetNextBlock=function(e,r){if(e>=this.metaData.stfsVolumeDescriptor.allocatedBlockCount)throw"STFS: reference to illegal block number.";var n=this.GetHashAddressOfBlock(e)+21;this.io.SetPosition(n),this.io.WriteInt24(r),this.topLevel==t.Level.Zero&&(this.topTable.entries[e].nextBlock=r)},r.prototype.AllocateBlock=function(){this.cached=new l,this.cached.addressInFile=0,this.cached.entryCount=0,this.cached.level=-1,this.cached.trueBlockNumber=4294967295;var e=4096;this.metaData.stfsVolumeDescriptor.allocatedBlockCount++;var n=[3];n[0]=Math.floor(this.metaData.stfsVolumeDescriptor.allocatedBlockCount/170)+(0!=this.metaData.stfsVolumeDescriptor.allocatedBlockCount%170?1:0),n[1]=Math.floor(n[0]/170)+(0!=n[0]%170&&this.metaData.stfsVolumeDescriptor.allocatedBlockCount>170?1:0),n[2]=Math.floor(n[1]/170)+(0!=n[1]%170&&this.metaData.stfsVolumeDescriptor.allocatedBlockCount>28900?1:0);for(var i=2;i>=0;i--)n[i]!=this.tablesPerLevel[i]&&(e+=4096*(this.packageSex+1),this.tablesPerLevel[i]=n[i],i+1==this.topLevel&&(this.topTable.entryCount++,this.topTable.entries.push(new o),this.topTable.entries[this.topTable.entryCount-1].status[0]=0,this.topTable.entries[this.topTable.entryCount-1].nextBlock=0,this.io.SetPosition(this.topTable.addressInFile+24*(this.tablesPerLevel[i]-1)+21),this.io.WriteInt24(r.INT24_MAX)));var s=this.ArrayBufferExtend(this.io.buffer,e);this.io.SetBuffer(s),this.io.SetPosition(this.io.buffer.byteLength-1);var a=this.CalculateTopLevel();if(this.topLevel!=a){this.topLevel=a,this.topTable.level=this.topLevel;var u=2&this.metaData.stfsVolumeDescriptor.blockSeperation[0];this.metaData.stfsVolumeDescriptor.blockSeperation[0]&=253,this.topTable.addressInFile=this.GetHashTableAddress(0,this.topLevel),this.topTable.entryCount=2,this.topTable.trueBlockNumber=this.ComputeLevelNBackingHashBlockNumber(0,this.topLevel),this.topTable.entries=[],this.topTable.entries[0].status[0]=u<<5,this.io.SetPosition(this.topTable.addressInFile+20),this.io.WriteByte(this.topTable.entries[0].status),this.metaData.stfsVolumeDescriptor.blockSeperation[0]&=253}return this.io.SetPosition(this.GetHashAddressOfBlock(this.metaData.stfsVolumeDescriptor.allocatedBlockCount-1)+20),this.io.WriteByte(new Uint8Array([128])),this.topLevel==t.Level.Zero&&(this.topTable.entryCount++,this.topTable.entries.push(new o),this.topTable.entries[this.metaData.stfsVolumeDescriptor.allocatedBlockCount-1].status[0]=t.BlockStatusLevelZero.Allocated,this.topTable.entries[this.metaData.stfsVolumeDescriptor.allocatedBlockCount-1].nextBlock=r.INT24_MAX),this.io.WriteInt24(r.INT24_MAX),this.metaData.WriteVolumeDescriptor(),this.metaData.stfsVolumeDescriptor.allocatedBlockCount-1},r.prototype.GetHashTableAddress=function(e,r){var n=this.GetBaseHashTableAddress(e,r);return this.packageSex==t.Sex.StfsFemale?n:(r=this.topTable.level)?n+((2&this.metaData.stfsVolumeDescriptor.blockSeperation[0])<<11):(this.io.SetPosition(this.GetTableHashAddress(e,r)),void 0)},r.prototype.GetBaseHashTableAddress=function(e,r){return(this.ComputeLevelNBackingHashBlockNumber(e*t.dataBlocksPerHashTreeLevel[r],r)<<12)+this.firstHashTableAddress},r.prototype.GetTableHashAddress=function(e,r){if(r>=this.topTable.level||r<t.Level.Zero)throw"STFS: level is invalid. No parent hash address accessible.";var n=this.GetBaseHashTableAddress(Math.floor(e/170),r+1);return n+=r+1==this.topLevel?(2&this.metaData.stfsVolumeDescriptor.blockSeperation[0])<<11:(64&this.topTable.entries[e].status[0])<<6,n+24*e},r.prototype.FindDirectoryListing=function(e,t){if(0==e.length)return t;for(var r=1==e.length,n=0;n<t.folderEntries.length;n++)if(t.folderEntries[n].folder.name==e[0]){if(e=e.slice(0,1),r)return t.folderEntries[n];for(var n=0;n<t.folderEntries.length;n++)return this.FindDirectoryListing(e,t.folderEntries[n])}},r.prototype.ReplaceFileFromPath=function(e,t,r){"undefined"==typeof r&&(r=null);var n=this.GetFileEntryFromPath(t);this.ReplaceFile(e,n,t,r)},r.prototype.ReplaceFile=function(n,i,o,l){if("undefined"==typeof l&&(l=null),0==i.nameLen[0])throw"STFS: file doesn't exists in the package.";var s=n.buffer.byteLength;i.fileSize=s,i.blocksForFile=(0xfffffff000&s+4095)>>12;var a=i.startingBlockNum;this.io.SetPosition(this.BlockToAddress(a));for(var u=Math.floor(s/4096),c=!0,h=!1,f=0;u>f;f++){if(c)c=!1;else{var d;h?(d=this.AllocateBlock(),this.SetNextBlock(a,d)):(d=this.GetBlockHashEntry(a).nextBlock,d==r.INT24_MAX&&(d=this.AllocateBlock(),this.SetNextBlock(a,d),h=!0)),a=d,this.io.SetPosition(this.BlockToAddress(a))}this.io.WriteBytes(n.ReadBytes(4096)),null!=l&&l(Math.floor(101/u)*f)}var p=s%4096;if(0!=p){var d;c||(h?(d=this.AllocateBlock(),this.SetNextBlock(a,d)):(d=this.GetBlockHashEntry(a).nextBlock,d==r.INT24_MAX&&(d=this.AllocateBlock(),this.SetNextBlock(a,d),h=!0)),a=d),this.io.SetPosition(this.BlockToAddress(a)),this.io.WriteBytes(n.ReadBytes(p))}if(this.SetNextBlock(a,r.INT24_MAX),i.flags[0]&=2,this.io.SetPosition(i.fileEntryAddress+40),this.io.WriteByte(new Uint8Array([i.nameLen[0]|i.flags[0]<<6])),this.io.WriteInt24(i.blocksForFile,e.IO.EndianType.LittleEndian),this.io.WriteInt24(i.blocksForFile,e.IO.EndianType.LittleEndian),this.io.SetPosition(i.fileEntryAddress+52),this.io.WriteDword(i.fileSize),this.UpdateEntry(o,i),this.topLevel=t.Level.Zero){this.io.SetPosition(this.topTable.addressInFile);for(var f=0;f<this.topTable.entryCount;f++)this.topTable.entries[f].blockHash=this.io.ReadBytes(20),this.topTable.entries[f].status=this.io.ReadByte(),this.topTable.entries[f].nextBlock=this.io.ReadInt24()}l&&l(100)},r.prototype.UpdateEntry=function(e,t){this.GetFileEntry(e.split("\\"),this.fileListing,t,!0)},r.prototype.GetLevelNHashTable=function(e,r){var n=new l;n.level=r,n.trueBlockNumber=this.ComputeLevelNBackingHashBlockNumber(e*t.dataBlocksPerHashTreeLevel[r],r);var i=(n.trueBlockNumber<<12)+this.firstHashTableAddress;if(0>r||r>this.topLevel)throw"STFS: invalid level.\n";if(r==this.topLevel)return this.topTable;r+1==this.topLevel?(i+=(64&this.topTable.entries[e].status[0])<<6,n.entryCount=e+1==this.tablesPerLevel[r]?r==t.Level.Zero?this.metaData.stfsVolumeDescriptor.allocatedBlockCount%170:this.tablesPerLevel[r-1]%170:170):(this.cached.trueBlockNumber!=this.ComputeLevelNBackingHashBlockNumber(170*e,t.Level.One)&&(this.cached=this.GetLevelNHashTable(e%170,t.Level.One)),i+=(64&this.cached.entries[e%170].status[0])<<6,n.entryCount=e+1==this.tablesPerLevel[r]?this.metaData.stfsVolumeDescriptor.allocatedBlockCount%170:170),n.addressInFile=i,this.io.SetPosition(n.addressInFile),n.entries=new Array(n.entryCount);for(var s=0;s<n.entryCount;s++)n.entries[s]=new o,n.entries[s].blockHash=this.io.ReadBytes(20),n.entries[s].status=this.io.ReadByte(),n.entries[s].nextBlock=this.io.ReadInt24();return n},r.prototype.Rehash=function(){var e;switch(this.topLevel){case t.Level.Zero:this.io.SetPosition(this.BlockToAddress(0));for(var r=0;r<this.topTable.entryCount;r++)e=this.io.ReadBytes(4096),this.topTable.entries[r].blockHash=sha1.hash(e);break;case t.Level.One:for(var r=0;r<this.topTable.entryCount;r++){var n=this.GetLevelNHashTable(r,t.Level.Zero);this.io.SetPosition(this.BlockToAddress(170*r));for(var i=0;i<n.entryCount;i++)e=this.io.ReadBytes(4096),n.entries[i].blockHash=this.HashBlock(e);e=this.BuildTableInMemory(n),this.io.SetPosition(n.addressInFile),this.io.WriteBytes(e),this.topTable.entries[r].blockHash=this.HashBlock(e)}break;case t.Level.Two:for(var r=0;r<this.topTable.entryCount;r++){for(var o=this.GetLevelNHashTable(r,t.Level.One),i=0;i<o.entryCount;i++){var n=this.GetLevelNHashTable(170*r+i,t.Level.Zero);this.io.SetPosition(this.BlockToAddress(28900*r+170*i));for(var l=0;l<n.entryCount;l++)e=this.io.ReadBytes(4096),n.entries[l].blockHash=this.HashBlock(e);e=this.BuildTableInMemory(n),this.io.SetPosition(n.addressInFile),this.io.WriteBytes(e),o.entries[i].blockHash=this.HashBlock(e)}e=this.BuildTableInMemory(o);var a;a=r+1==this.topTable.entryCount?0==this.metaData.stfsVolumeDescriptor.allocatedBlockCount%28900?28900:this.metaData.stfsVolumeDescriptor.allocatedBlockCount%28900:28900,e[4080]=255&a,e[4081]=255&a>>8,e[4082]=255&a>>16,e[4083]=255&a>>24,this.io.SetPosition(o.addressInFile),this.io.WriteBytes(e),this.topTable.entries[r].blockHash=this.HashBlock(e)}}if(e=this.BuildTableInMemory(this.topTable),this.topTable.level>=t.Level.One){var u=this.metaData.stfsVolumeDescriptor.allocatedBlockCount;e[4080]=255&u,e[4081]=255&u>>8,e[4082]=255&u>>16,e[4083]=255&u>>24}this.metaData.stfsVolumeDescriptor.topHashTableHash=this.HashBlock(e),this.io.SetPosition(this.topTable.addressInFile),this.io.WriteBytes(e),this.metaData.WriteVolumeDescriptor();var c;c=this.flags&s.StfsPackagePEC?572:836;var h=61440&this.metaData.headerSize+4095,f=h-c,d=new Uint8Array(f);this.io.SetPosition(c),d=this.io.ReadBytes(f),this.metaData.headerHash=sha1.hash(d),this.metaData.WriteMetaData()},r.prototype.BuildTableInMemory=function(e){for(var t=new Uint8Array(4096),r=0;r<e.entryCount;r++){for(var n=0;20>n;n++)t[24*r+n]=e.entries[r].blockHash[n];t[24*r+21]=255&e.entries[r].nextBlock>>16,t[24*r+22]=255&e.entries[r].nextBlock>>8,t[24*r+23]=255&e.entries[r].nextBlock}return t},r.prototype.RenameFile=function(e,t){var r=this.io.Clone(this.GetFileEntryFromPath(t,!0));r.name=e,r=this.GetFileEntryFromPath(t,!0,r),this.io.SetPosition(r.fileEntryAddress),this.WriteFileEntry(r)},r.prototype.ArrayBufferExtend=function(e,t){var r=new Uint8Array(e.byteLength+t);return r.set(new Uint8Array(e),0),r.buffer},r.prototype.ArrayBufferConcat=function(e,t){var r=new Uint8Array(e.byteLength+t.byteLength);return r.set(new Uint8Array(e),0),r.set(new Uint8Array(t),t.byteLength),r.buffer},r.INT24_MAX=8388607,r}();t.StfsPackage=r;var n=function(){function e(){}return e}();t.StfsFileEntry=n;var i=function(){function e(){this.fileEntries=[],this.folderEntries=[],this.folder=new n}return e}();t.StfsFileListing=i;var o=function(){function e(){this.blockHash=new Uint8Array(20),this.status=new Uint8Array(1)}return e}();t.HashEntry=o;var l=function(){function e(){}return e}();t.HashTable=l,function(e){e[e.StfsPackagePEC=1]="StfsPackagePEC",e[e.StfsPackageCreate=2]="StfsPackageCreate",e[e.StfsPackageFemale=4]="StfsPackageFemale"}(t.StfsPackageFlags||(t.StfsPackageFlags={}));var s=t.StfsPackageFlags}(e.Stfs||(e.Stfs={})),e.Stfs}(XboxInternals||(XboxInternals={}));